{{extend 'layout.html'}}

{{import json}}

{{block header_script}}
	<script>
		var URL = {
        	submitReply: '{{=URL("default","submit_discussion_reply")}}'
		},
		ENV = {
			discussionId: '{{=discussion_id}}'
		}


		var addBuble = function(id, message, timestamp, userName, isCurrentUserMessage){
			// Create bubble in memory.
			// Note: this is not a good practice. Ideally we'd use some sort of template engine, e.g. Mustache. But this is faster right now.
			var container = $('#chatHistory');
			var chatPanel = $('<div></div>').attr({
				class: 'chatPanel'
			});
			var userPostfix = isCurrentUserMessage ? ' user' : '';
			var chatMessage = $('<p></p>').attr({
				class: 'chatMessage' + userPostfix
			}).text(message);
			var userName = isCurrentUserMessage ? 'Me' : userName;
			var timestamp = $('<p></p>').attr({
				class: 'timeStamp' + userPostfix
			}).text(userName + ' | '+ timestamp);
			// Check if this is the first message, and if it is, switch the views
			if(container.children().length == 0){
				container.show();
				$('.noData').hide();
			}
			// Add to DOM
			chatPanel.append(chatMessage).append(timestamp).hide();
			container.append(chatPanel);
			chatPanel.fadeIn('fast');
		};

		var openTask = function(name, points, taskDefinition){
			openOverlay('#taskPopup', function(){
				var inputList = $('#taskPopup ul').empty();
				// For each input item, create ot amd add it to the DOM
				taskDefinition.forEach(function(d,i){
					var item = JSON.parse(d);
					var li = $('<li></li>');
					var label = $('<label>'+item.label+'</label>').attr({
						for: item.name
					});
					var input = $('<input/>').attr({
						type: item.type,
						name: item.name
					});
					li.append(label).append(input);
					inputList.append(li);
				});
				// Setup submit button
				var submitButton = $('#taskPopup a.button');
				submitButton.text('Submit (+'+points+')');
			});
			
		};

		var openOverlay = function(id, setupFunction){
			var overlay = $('#overlay');
			overlay.show('slow');
			$(id, overlay).show('slow');
			if(setupFunction){
				setupFunction();
			}
		}

		function closeOverlay(){
			var overlay = $('#overlay');
			overlay.hide('slow');
			$('.popup').hide('slow');
		}

		$(function(){
			$('.close').click(function(){
				closeOverlay();
			});

			// Scroll to bottom
			$("html, body").animate({ scrollTop: $(document).height() }, 1000);

			// Attach event handlers
			$('#back').click(function(){
				window.location.href = "{{=URL('default','page')}}?page_num={{=page_num}}";
			});

			$('#replyButton').click(function(){
				var text = $('#replyBox').val();
				if(text){
					$.ajax({
						method: 'POST',
						url: URL.submitReply,
						data: {
							message: text,
							discussion_id: ENV.discussionId
						},
						success: function(data){
							var reply = JSON.parse(data);
							addBuble(reply.id, reply.message, reply.timestamp, reply.user_name, true);
						}
					});
				}
				// Clear reply box
				$('#replyBox').val('');
				return false;
			});
		});
	</script>
{{end}}

<a href="#" id="back">< Back</a>
<h2>{{=discussion.title}}</h2>
<p class= "description">{{=discussion.description}}</p>

<div id="chatHistory" style="display: {{= ('block' if len(discussion_messages) > 0 else 'none') }}">
	{{for dm in discussion_messages:}}
		{{current_user_message = dm.discussion_message.added_by == current_user_id}}
		<div class="chatPanel">
			<div class="chatMessage {{='user' if current_user_message else ''}}">
				<p>
					{{=dm.discussion_message.message_content}}
				</p>
				{{if not current_user_message:}}
					<ul>
						{{for t in tasks:}}
						<li>
							<img src="{{=URL('static', 'images/' + t.icon)}}" 
								alt="{{=t.name}}" 
								onclick="openTask('{{=t.name}}', {{=t.points}}, {{=json.dumps(t.task_template)}})">
						</li>
						{{pass}}
					</ul>
				{{pass}}
			</div>
			<p class="timeStamp {{='user' if current_user_message else ''}}">
				{{= 'Me' if current_user_message else dm.user_info.name}} | {{=dm.discussion_message.date_added}}
			</p>
		</div>
	{{pass}}
</div>

<p class="noData" style="display: {{= ('none' if len(discussion_messages) > 0 else 'block') }}">There are no replies to this discussion yet. Want to be the first? :)</p>

<div class="replyPanel">
	<input id="replyBox" type="text" placeholder="Enter a reply here" size="70"/>
	<a id="replyButton" href="#">
		Send
	</a>
</div>

<div id="overlay">
    <div id="taskPopup" class="popup">
		<div class="close">
			<img src="{{=URL('static','images/close.png')}}" alt="">
		</div>
		<h2>Contribute</h2>
		<ul>
		</ul>
		<a href="#" class="button submit">Submit (+5)</a>
    </div>
</div>